<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë¨¹ì§€? - ì„±ê²°ëŒ€ ë§›ì§‘ ê°€ì´ë“œ</title>
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{.ApiKey}}&libraries=services"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

        :root { --primary: #007bff; --accent: #ffc107; --bg: #f8f9fa; --border: #dee2e6; }
        * { box-sizing: border-box; }
        
        html, body { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
            overflow: hidden; 
        }

        .app-container { display: flex; flex-direction: column; height: 100vh; }

        /* ì»¨íŠ¸ë¡¤ëŸ¬ ì˜ì—­ */
        .header { background: #fff; border-bottom: 1px solid var(--border); z-index: 10; padding: 0; }
        
        #category-filter { background: #343a40; padding: 10px; text-align: center; }
        #category-filter button {
            margin: 2px; padding: 6px 12px; border-radius: 4px;
            border: none; background: #495057; color: #fff; cursor: pointer;
            font-size: 13px; transition: 0.2s;
        }
        #category-filter button:hover, #category-filter button.active { background: var(--primary); }

        #search-box { padding: 10px 16px; border-bottom: 1px solid #ddd; background: #fff; display: flex; gap: 8px; align-items: center; }
        #search-box input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-pick { padding: 8px 15px; background: var(--accent); color: #333; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }

        .recommend-display { background: #fffbe6; padding: 8px 16px; border-bottom: 1px solid #ffe58f; font-size: 14px; }
        #recommended-link { color: var(--primary); font-weight: bold; text-decoration: none; }

        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
        .main { 
            display: flex; 
            flex: 1; 
            height: calc(100vh - 160px); /* í—¤ë” ë†’ì´ ì œì™¸ */
            overflow: hidden; 
        }

        .sidebar { 
            width: 350px; 
            border-right: 1px solid var(--border); 
            overflow-y: auto; 
            background: #fff; 
        }

        #r-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        #r-table th { background: #f1f1f1; padding: 10px; position: sticky; top: 0; z-index: 5; font-size: 14px; border-bottom: 2px solid var(--border); }
        #r-table td { padding: 15px; border-bottom: 1px solid #f1f1f1; vertical-align: top; cursor: pointer; transition: background 0.2s; }
        #r-table tr:hover td { background: #f8f9fa; }

        .title { font-weight: bold; color: var(--primary); text-decoration: none; font-size: 16px; display: block; margin-bottom: 5px; }
        .addr { font-size: 13px; color: #666; line-height: 1.4; display: block; }
        .food { font-size: 11px; color: #999; margin-top: 5px; display: inline-block; padding: 2px 6px; background: #eee; border-radius: 4px; }

        .map-area { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }

        @media (max-width: 768px) {
            .main { flex-direction: column-reverse; }
            .sidebar { width: 100%; height: 40%; }
            .map-area { height: 60%; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div id="category-filter">
            <button class="active" onclick="applyFilter('all', this)">ì „ì²´</button>
            <button onclick="applyFilter('êµ­ìˆ˜', this)">êµ­ìˆ˜</button>
            <button onclick="applyFilter('ì¤‘ì‹', this)">ì¤‘ì‹</button>
            <button onclick="applyFilter('ë¶„ì‹', this)">ë¶„ì‹</button>
            <button onclick="applyFilter('ê³ ê¸°', this)">ê³ ê¸°</button>
            <button onclick="applyFilter('ì¹˜í‚¨', this)">ì¹˜í‚¨</button>
            <button onclick="applyFilter('ìˆ ì§‘', this)">ìˆ ì§‘</button>
            <button onclick="applyFilter('ì¹´í˜', this)">ì¹´í˜</button>
        </div>
        <div id="search-box">
            <input type="text" id="search-input" placeholder="ì„±ê²°ëŒ€ ì£¼ë³€ ë§›ì§‘/ì¹´í˜ ê²€ìƒ‰..." onkeyup="if(event.key==='Enter') applySearch()">
            <button class="btn-pick" onclick="pickRandom()">ğŸ² ë¬´ì‘ìœ„ ì¶”ì²œ</button>
        </div>
    </div>

    <div class="recommend-display">
        ğŸ“ <strong>ì˜¤ëŠ˜ì˜ ì¶”ì²œ:</strong> 
        <a id="recommended-link" href="#" target="_blank">ë¦¬ìŠ¤íŠ¸ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì£¼ì‚¬ìœ„ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”!</a>
    </div>

    <div class="main">
        <div class="sidebar">
            <table id="r-table">
                <thead>
                    <tr><th>ë§›ì§‘ ë¦¬ìŠ¤íŠ¸</th></tr>
                </thead>
                <tbody id="res-list">
                    </tbody>
            </table>
        </div>
        <div class="map-area">
            <div id="map"></div>
        </div>
    </div>
</div>

<script>
    /** 1. ì§€ë„ ì´ˆê¸°í™” ë° ì•ˆì–‘ 8ë™ í´ë¦¬ê³¤ **/
    let map, currentMarker = null, currentOverlay = null;
    const boundaryCoords = [
        [126.936009, 37.383260], [126.936242, 37.382663], 
        [126.936444, 37.382211], [126.936508, 37.382068], 
        [126.936646, 37.381803], [126.936743, 37.381642], 
        [126.936765, 37.381605], [126.936910, 37.381366], 
        [126.937138, 37.381042], [126.937483, 37.380612], 
        [126.937944, 37.380137], [126.938376, 37.379733], 
        [126.938679, 37.379465], [126.938863, 37.379302], 
        [126.939684, 37.378558], [126.940026, 37.378230], 
        [126.940195, 37.378053], [126.940214, 37.378032], 
        [126.940296, 37.377945], [126.940511, 37.377704], 
        [126.940739, 37.377422], [126.940785, 37.377360], 
        [126.940877, 37.377235], [126.940956, 37.377128], 
        [126.941185, 37.376762], [126.940555, 37.376242], 
        [126.940511, 37.376205], [126.940318, 37.376048], 
        [126.940076, 37.375851], [126.939165, 37.376011], 
        [126.937373, 37.376555], [126.934893, 37.376996], 
        [126.932765, 37.377470], [126.930979, 37.377528], 
        [126.926947, 37.377638], [126.924137, 37.377312], 
        [126.923923, 37.377256], [126.921417, 37.376518], 
        [126.919899, 37.376564], [126.919178, 37.376933], 
        [126.919210, 37.377178], [126.919285, 37.377544], 
        [126.919353, 37.377714], [126.919431, 37.377818], 
        [126.920582, 37.379335], [126.921934, 37.380899], 
        [126.924169, 37.383026], [126.925436, 37.384031], 
        [126.925688, 37.384199], [126.925741, 37.384224], 
        [126.925790, 37.384248], [126.932237, 37.385795], 
        [126.933770, 37.383967], [126.933825, 37.383896], 
        [126.936009, 37.383261]
    ];

    function initMap() {
        const mapContainer = document.getElementById('map');
        const mapOption = { center: new kakao.maps.LatLng(37.383, 126.932), level: 3 };
        map = new kakao.maps.Map(mapContainer, mapOption);

        const polygonPath = boundaryCoords.map(c => new kakao.maps.LatLng(c[1], c[0]));
        new kakao.maps.Polygon({
            path: polygonPath, strokeWeight: 3, strokeColor: '#FF0000', strokeOpacity: 0.8,
            fillColor: '#FF0000', fillOpacity: 0.05
        }).setMap(map);
    }
    function filterByCategory(category) {
    // API í˜¸ì¶œ ì‹œ ì¹´í…Œê³ ë¦¬ íŒŒë¼ë¯¸í„° ì¶”ê°€
    fetch(`/api/restaurants?category=${category}`)
        .then(res => res.json())
        .then(data => {
            renderList(data);  // ëª©ë¡ ì—…ë°ì´íŠ¸
            displayMarkers(data); // ì§€ë„ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        });
}

    /** 2. ë°±ì—”ë“œ API ì—°ë™ ë¡œì§ **/
    async function fetchData(category = 'all', search = '') {
        const url = `http://localhost:8080/api/restaurants?category=${category}&search=${search}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            renderList(data);
        } catch (error) {
            console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
        }
    }

    function renderList(data) {
        const listBody = document.getElementById('res-list');
        listBody.innerHTML = '';
        
        data.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <a class="title" href="${item.url}" target="_blank">${item.title}</a>
                    <span class="addr">${item.addr}</span>
                    <span class="food">${item.food}</span>
                </td>
            `;
            tr.onclick = () => focusOn(item);
            listBody.appendChild(tr);
        });
    }

    /** 3. ë‹¨ì¼ ë§ˆì»¤ ì‹œìŠ¤í…œ **/
    function focusOn(item) {
        if (currentMarker) currentMarker.setMap(null);
        if (currentOverlay) currentOverlay.setMap(null);

        const pos = new kakao.maps.LatLng(item.y, item.x);
        currentMarker = new kakao.maps.Marker({ position: pos, map: map });
        
        currentOverlay = new kakao.maps.CustomOverlay({
            position: pos,
            content: `<div class="map-overlay" style="padding:5px 10px; background:white; border:1px solid #888; border-radius:5px; font-size:12px; bottom:40px; position:relative; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); font-weight:bold;">${item.title}</div>`,
            yAnchor: 1
        });
        currentOverlay.setMap(map);
        map.panTo(pos);
    }

    /** 4. í•„í„° ë° ë¬´ì‘ìœ„ ì¶”ì²œ **/
    function applyFilter(category, btn) {
        document.querySelectorAll('#category-filter button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        fetchData(category, document.getElementById('search-input').value);
    }

    function applySearch() {
        const keyword = document.getElementById('search-input').value;
        fetchData('all', keyword);
    }

    async function pickRandom() {
        try {
            const response = await fetch('http://localhost:8080/api/restaurants/random');
            const pick = await response.json();
            
            const link = document.getElementById('recommended-link');
            link.textContent = `${pick.title} (${pick.food})`;
            link.href = pick.url;
            focusOn(pick);
        } catch (error) {
            console.error("ì¶”ì²œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ì´ˆê¸°í™” ì‹¤í–‰
    initMap();
    fetchData();
</script>

</body>
</html>