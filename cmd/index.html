<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>skueat - ì„±ê²°ëŒ€ ë§›ì§‘ ê°€ì´ë“œ</title>
    
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{.ApiKey}}&libraries=services"></script>
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.1.0/kakao.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');

        :root {
            --primary: #0056a8; /* ì„±ê²°ëŒ€ ë¸”ë£¨ */
            --accent: #ff9f43;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #1a1a1a;
            --text-sub: #707070;
            --border: #eceef0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; padding: 0; height: 100vh; 
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            overflow: hidden; 
        }

        .app-container { display: flex; flex-direction: column; height: 100vh; }

        /* í—¤ë” ì˜ì—­ */
        .header { 
            background: #fff; 
            padding: 12px 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .logo { font-size: 22px; font-weight: 800; color: var(--primary); letter-spacing: -1px; }
        
        #auth-area { display: flex; align-items: center; }
        .kakao-login-btn { cursor: pointer; height: 32px; transition: opacity 0.2s; }
        .user-profile { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; }
        .user-profile img { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border); }

        .search-row { display: flex; gap: 8px; margin-bottom: 12px; }
        #search-input { 
            flex: 1; padding: 12px 16px; 
            border: 2px solid var(--border); border-radius: 12px; 
            font-size: 15px; outline: none; transition: 0.2s;
        }
        #search-input:focus { border-color: var(--primary); }

        .btn-random { 
            padding: 0 16px; background: var(--accent); color: #fff; 
            border: none; border-radius: 12px; cursor: pointer; 
            font-weight: bold; font-size: 20px;
        }

        .category-scroll {
            display: flex; gap: 8px; overflow-x: auto; 
            padding-bottom: 4px; scrollbar-width: none;
        }
        .category-scroll::-webkit-scrollbar { display: none; }
        .cat-btn {
            white-space: nowrap; padding: 8px 16px; border-radius: 20px;
            border: 1px solid var(--border); background: #fff;
            color: var(--text-sub); font-size: 13px; cursor: pointer; transition: 0.2s;
        }
        .cat-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: 600; }

        /* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ */
        .main-content { display: flex; flex: 1; overflow: hidden; }

        /* ì‚¬ì´ë“œë°” ë¦¬ìŠ¤íŠ¸ */
        .sidebar { 
            width: 380px; background: var(--bg);
            display: flex; flex-direction: column;
            border-right: 1px solid var(--border);
        }
        .list-info { padding: 12px 16px; font-size: 13px; color: var(--text-sub); border-bottom: 1px solid var(--border); }
        #res-list { flex: 1; overflow-y: auto; padding: 12px; }

        /* ë§›ì§‘ ì¹´ë“œ ë””ìì¸ */
        .res-card {
            background: var(--card-bg); border-radius: 16px;
            padding: 16px; margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            cursor: pointer; transition: 0.2s; border: 2px solid transparent;
        }
        .res-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .res-card.active { border-color: var(--primary); background: #f0f7ff; }

        .res-title { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 4px; display: block; text-decoration: none; }
        .res-addr { font-size: 13px; color: var(--text-sub); line-height: 1.4; margin-bottom: 8px; }
        
        /* ë³„ì  UI */
        .rating-container { display: flex; align-items: center; gap: 4px; }
        .star { color: #ddd; font-size: 18px; cursor: pointer; }
        .star.filled { color: #ffbc00; }
        .rating-val { font-size: 14px; font-weight: 700; color: #444; margin-left: 4px; }

        /* ì§€ë„ ì˜ì—­ */
        .map-area { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }

        /* ë°˜ì‘í˜• ì„¤ì • */
        @media (max-width: 768px) {
            .main-content { flex-direction: column-reverse; }
            .sidebar { width: 100%; height: 45%; border-right: none; border-top: 1px solid var(--border); }
            .map-area { height: 55%; }
        }

        .custom-overlay {
            background: var(--primary); color: white; padding: 6px 12px;
            border-radius: 20px; font-size: 12px; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div class="app-container">
    <header class="header">
        <div class="top-bar">
            <div class="logo">skueat</div>
            <div id="auth-area">
                <img src="https://k.kakaocdn.net/14/dn/btroDszwNrM/K66Yq3z6TaOf4yabPLW48k/o.jpg" 
                     class="kakao-login-btn" onclick="loginWithKakao()" alt="ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸">
            </div>
        </div>
        <div class="search-row">
            <input type="text" id="search-input" placeholder="ë§›ì§‘ ì´ë¦„ì´ë‚˜ ë©”ë‰´ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”" onkeyup="if(event.key==='Enter') applySearch()">
            <button class="btn-random" onclick="pickRandom()">ğŸ²</button>
        </div>
        <nav class="category-scroll" id="category-filter">
            <button class="cat-btn active" onclick="applyFilter('all', this)">ì „ì²´</button>
            <button class="cat-btn" onclick="applyFilter('êµ­ìˆ˜', this)">ğŸœ êµ­ìˆ˜</button>
            <button class="cat-btn" onclick="applyFilter('ì¤‘ì‹', this)">ğŸ‡¨ğŸ‡³ ì¤‘ì‹</button>
            <button class="cat-btn" onclick="applyFilter('ë¶„ì‹', this)">ğŸ¢ ë¶„ì‹</button>
            <button class="cat-btn" onclick="applyFilter('ê³ ê¸°', this)">ğŸ¥© ê³ ê¸°</button>
            <button class="cat-btn" onclick="applyFilter('ì¹˜í‚¨', this)">ğŸ— ì¹˜í‚¨</button>
            <button class="cat-btn" onclick="applyFilter('ìˆ ì§‘', this)">ğŸº ìˆ ì§‘</button>
            <button class="cat-btn" onclick="applyFilter('ì¹´í˜', this)">â˜• ì¹´í˜</button>
        </nav>
    </header>

    <main class="main-content">
        <aside class="sidebar">
            <div class="list-info" id="list-count">ë§›ì§‘ ë¦¬ìŠ¤íŠ¸</div>
            <div id="res-list"></div>
        </aside>
        <section class="map-area">
            <div id="map"></div>
        </section>
    </main>
</div>

<script>
    // ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
    Kakao.init('YOUR_KAKAO_JS_KEY'); 
    let map, currentMarker = null, currentOverlay = null;
    let currentUser = null;

    // ê¸°ì¡´ ì•ˆì–‘ 8ë™ ê²½ê³„ ì¢Œí‘œ ë°ì´í„°
    const boundaryCoords = [
        [126.936009, 37.383260], [126.936242, 37.382663], [126.936444, 37.382211], [126.936508, 37.382068], 
        [126.936646, 37.381803], [126.936743, 37.381642], [126.936765, 37.381605], [126.936910, 37.381366], 
        [126.937138, 37.381042], [126.937483, 37.380612], [126.937944, 37.380137], [126.938376, 37.379733], 
        [126.938679, 37.379465], [126.938863, 37.379302], [126.939684, 37.378558], [126.940026, 37.378230], 
        [126.940195, 37.378053], [126.940214, 37.378032], [126.940296, 37.377945], [126.940511, 37.377704], 
        [126.940739, 37.377422], [126.940785, 37.377360], [126.940877, 37.377235], [126.940956, 37.377128], 
        [126.941185, 37.376762], [126.940555, 37.376242], [126.940511, 37.376205], [126.940318, 37.376048], 
        [126.940076, 37.375851], [126.939165, 37.376011], [126.937373, 37.376555], [126.934893, 37.376996], 
        [126.932765, 37.377470], [126.930979, 37.377528], [126.926947, 37.377638], [126.924137, 37.377312], 
        [126.923923, 37.377256], [126.921417, 37.376518], [126.919899, 37.376564], [126.919178, 37.376933], 
        [126.919210, 37.377178], [126.919285, 37.377544], [126.919353, 37.377714], [126.919431, 37.377818], 
        [126.920582, 37.379335], [126.921934, 37.380899], [126.924169, 37.383026], [126.925436, 37.384031], 
        [126.925688, 37.384199], [126.925741, 37.384224], [126.925790, 37.384248], [126.932237, 37.385795], 
        [126.933770, 37.383967], [126.933825, 37.383896], [126.936009, 37.383261]
    ];

    function initMap() {
        const container = document.getElementById('map');
        const options = { center: new kakao.maps.LatLng(37.383, 126.932), level: 3 };
        map = new kakao.maps.Map(container, options);

        // ì•ˆì–‘ 8ë™ ê²½ê³„ í‘œì‹œ (í´ë¦¬ê³¤)
        const polygonPath = boundaryCoords.map(c => new kakao.maps.LatLng(c[1], c[0]));
        const polygon = new kakao.maps.Polygon({
            path: polygonPath,
            strokeWeight: 3,
            strokeColor: '#FF0000', // ê²½ê³„ì„  ê°•ì¡°ë¥¼ ìœ„í•´ ë¹¨ê°„ìƒ‰ ìœ ì§€
            strokeOpacity: 0.6,
            fillColor: '#FF0000',
            fillOpacity: 0.05
        });
        polygon.setMap(map);
    }

    // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
    function loginWithKakao() {
        Kakao.Auth.login({
            success: function(authObj) {
                Kakao.API.request({
                    url: '/v2/user/me',
                    success: function(res) {
                        currentUser = res.kakao_account.profile;
                        updateUIWithUser(currentUser);
                    }
                });
            }
        });
    }

    function updateUIWithUser(user) {
        document.getElementById('auth-area').innerHTML = `
            <div class="user-profile">
                <img src="${user.thumbnail_image_url}">
                <span>${user.nickname}</span>
            </div>
        `;
    }

    // ë°ì´í„° íŒ¨ì¹­
    async function fetchData(category = 'all', search = '') {
        const url = `/api/restaurants?category=${category}&search=${search}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            renderList(data);
        } catch (e) {
            console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", e);
        }
    }

    function renderList(data) {
        const container = document.getElementById('res-list');
        const count = document.getElementById('list-count');
        container.innerHTML = '';
        count.textContent = `ì´ ${data.length}ê°œì˜ ë§›ì§‘`;

        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'res-card';
            const rating = item.rating || 0; 
            
            card.innerHTML = `
                <a class="res-title" href="${item.url}" target="_blank" onclick="event.stopPropagation()">${item.title}</a>
                <div class="rating-container">
                    ${[1,2,3,4,5].map(i => `<span class="star ${i <= Math.round(rating) ? 'filled' : ''}" onclick="rate('${item.title}', ${i}, event)">â˜…</span>`).join('')}
                    <span class="rating-val">${rating.toFixed(1)}</span>
                </div>
                <div class="res-addr">${item.addr}</div>
            `;
            card.onclick = () => focusOn(item, card);
            container.appendChild(card);
        });
    }

    function rate(title, score, event) {
        event.stopPropagation();
        if (!currentUser) {
            alert("ë³„ì ì„ ë‚¨ê¸°ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤! ğŸ”’");
            return;
        }
        alert(`${title}ì— ${score}ì ì„ ì£¼ì…¨ìŠµë‹ˆë‹¤.`);
    }

    function focusOn(item, cardElement) {
        document.querySelectorAll('.res-card').forEach(c => c.classList.remove('active'));
        if(cardElement) cardElement.classList.add('active');

        if (currentMarker) currentMarker.setMap(null);
        if (currentOverlay) currentOverlay.setMap(null);

        const pos = new kakao.maps.LatLng(item.y, item.x);
        currentMarker = new kakao.maps.Marker({ position: pos, map: map });
        currentOverlay = new kakao.maps.CustomOverlay({
            position: pos, content: `<div class="custom-overlay">${item.title}</div>`, yAnchor: 2.2
        });
        currentOverlay.setMap(map);
        map.panTo(pos);
    }

    function applyFilter(category, btn) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        fetchData(category, document.getElementById('search-input').value);
    }

    function applySearch() {
        const activeCat = document.querySelector('.cat-btn.active').textContent.split(' ').pop();
        fetchData(activeCat === 'ì „ì²´' ? 'all' : activeCat, document.getElementById('search-input').value);
    }

    async function pickRandom() {
        const res = await fetch('/api/restaurants/random');
        const pick = await res.json();
        const cards = document.querySelectorAll('.res-card');
        cards.forEach(card => {
            if(card.querySelector('.res-title').textContent === pick.title) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                focusOn(pick, card);
            }
        });
    }

    window.onload = () => {
        initMap();
        fetchData();
    };
</script>

</body>
</html>